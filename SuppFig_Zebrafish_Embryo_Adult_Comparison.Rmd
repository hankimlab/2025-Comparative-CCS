---
title: "SuppFig_Zebrafish_Embryo_Adult_Comparison"
output: html_document
date: "2025-08-28"
---

# compare zebrafish embryo and adult SAN
```{r}

dr_san_a_vs_e_raw <- FindMarkers(merged, ident.1='SA node (6-12mo)', ident.2 = 'SA node (48-72hpf)')

dr_san_a_vs_e <- dr_san_a_vs_e_raw %>%
  filter(
    p_val_adj <= 0.05,
    (avg_log2FC >= log2(1.5) | avg_log2FC <= -log2(1.5)),
    (pct.1 >= 0.1 | pct.2 >= 0.1), (pct.1 > 0 & pct.2 > 0)
  ) %>%
  rownames_to_column(var = "gene") %>%
  arrange(
    desc(avg_log2FC > 0)   # all rows with avg_log2FC>0 first, then the rest
  )

# keep only genes that are significantly different b/w embryo and adult, and SAN markers in either
dr_san_a_vs_e_filt_embhigh <- dr_san_a_vs_e_raw %>%
  filter(
    p_val_adj <= 0.05,
    abs(avg_log2FC) >= log2(1.5),
    pct.1 >= 0.1 | pct.2 >= 0.1
  ) %>%
  rownames_to_column(var = "gene") %>%
  filter(gene %in% union(dr_san_e, dr_san_a), avg_log2FC < 0)

dr_san_a_vs_e_filt_adulthigh <- dr_san_a_vs_e_raw %>%
  filter(
    p_val_adj <= 0.05,
    abs(avg_log2FC) >= log2(1.5),
    pct.1 >= 0.1 | pct.2 >= 0.1
  ) %>%
  rownames_to_column(var = "gene") %>%
  filter(gene %in% union(dr_san_e, dr_san_a), avg_log2FC > 0)

ic <- read.csv('group-177.csv', header=F)
ic <- ic[-c(1, 2), ]
ic <- ic$V2

ion_channel_dr_genes <- unlist(hs_to_dr_list[ic])
ion_channel_dr_genes <- unique(ion_channel_dr_genes)

tfs <- read.table('https://humantfs.ccbr.utoronto.ca/download/v_1.01/TF_names_v_1.01.txt')
tfs <- tfs$V1

tf_dr_genes <- unlist(hs_to_dr_list[tfs])
tf_dr_genes <- unique(tf_dr_genes)

lig1 <- read.csv('ligands_group.csv', header=F)
lig1 <- lig1[-c(1, 2), ]
lig2 <- read.csv('ligands_subgroups.csv', header=F)
lig2 <- lig2[-c(1, 2), ]
lig2 <- lig2[, !names(lig2) %in% "V7"]
lig <- rbind(lig1, lig2)
lig <- lig$V2

lig_dr_genes <- unlist(hs_to_dr_list[lig])
lig_dr_genes <- unique(lig_dr_genes)

sarc <- read.table('sarcomere_genes.txt', header=T, fill = TRUE, stringsAsFactors = FALSE)
sarc <- unique(sarc$Gene.Marker)
sarc <- ortholog_df[ortholog_df$mm %in% sarc,]$hs

sarc_dr_genes <- unlist(hs_to_dr_list[sarc])
sarc_dr_genes <- unique(sarc_dr_genes)

library(ComplexHeatmap)
library(circlize)
library(RColorBrewer)

expr_mat <- GetAssayData(merged, slot = "scale.data")[dr_san_a_vs_e$gene, 
              WhichCells(merged, idents = c('48-72hpf - SA node', '6-12mo - SA node'))]

expr_mat_t <- t(as.matrix(expr_mat))

# highlight_genes <- colnames(expr_mat_t)[colnames(expr_mat_t) %in% c(tf_dr_genes, ion_channel_dr_genes, lig_dr_genes)]
# 
# # column indices for annotation
# col_idx <- which(colnames(expr_mat_t) %in% highlight_genes)

fig <- Heatmap(
  expr_mat_t[nrow(expr_mat_t):1, ncol(expr_mat_t):1],
  name = "Scaled\nexpression",
  show_row_names = FALSE,
  show_column_names = FALSE,
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  col = colorRamp2(c(-3, 0, 3), c("#2166ac", "#fff", "#b2182b")),
  heatmap_legend_param = list(
    title_gp = gpar(fontface = "plain")
  )
)

tiff(
  filename = "dr_a_vs_e_heatmap.tiff",
  width = 12,
  height = 5,
  units = "in",
  res = 600
)

draw(fig)

dev.off()

fig <- DotPlot(
  merged,
  features = c(unique(unlist(lapply(list(
    tf_dr_genes,
    lig_dr_genes,
    ion_channel_dr_genes,
    sarc_dr_genes
  ),
  function(x)
    intersect(x, dr_san_a_vs_e_filt_embhigh$gene)))),
  unique(unlist(lapply(list(
    tf_dr_genes,
    lig_dr_genes,
    ion_channel_dr_genes,
    sarc_dr_genes
  ),
  function(x)
    intersect(x, dr_san_a_vs_e_filt_adulthigh$gene))))),
  idents = c(
    "SA node (48-72hpf)",
    "SA node (6-12mo)",
    "AVC (48-72hpf)",
    "aCM (48-72hpf)",
    "aCM (6-12mo)",
    "vCM (48-72hpf)",
    "vCM (6-12mo)"
  ),
  cols = c('whitesmoke', '#386641'),
  col.min = -1,
  col.max = 1.5,
  dot.scale = 10,
  dot.min = -0.10
) &
  scale_size_area(
    limits = c(0, 100),
    max_size = 6.5,
    breaks = c(0, 20, 40, 60, 80, 100)
  ) &
  theme(
    axis.line = element_blank(),
    panel.border = element_rect(
      color = "black",
      fill = NA,
      size = 1
    ),
    axis.title = element_blank(),
    axis.text.x = element_text(
      face = 'italic',
      hjust = 1,
      vjust = 0.5,
      size = 14,
      angle = 90
    ),
    axis.text.y = element_text(size=14)
  ) & NoLegend()

ggsave(
  "dr_embadult_combined_dotplot.tiff",
  fig,
  dpi = 600,
  width = 10,
  height = 3.25
)

```